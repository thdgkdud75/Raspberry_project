<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>실시간 카메라 + ml5 객체 인식</title>

  <!-- ✅ Socket.IO는 서버가 제공하는 걸 사용 (버전 불일치 방지) -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <!-- ✅ ml5는 0.12.2로 고정 -->
  <script src="https://unpkg.com/ml5@0.12.2/dist/ml5.min.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 16px; }
    .wrap { display: flex; gap: 16px; align-items: flex-start; }
    .panel { width: 360px; }
    #cam { width: 640px; height: auto; background: #111; border-radius: 12px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; }
    .title { font-weight: 800; margin-bottom: 8px; }
    .msg { font-size: 18px; font-weight: 800; padding: 12px; border-radius: 12px; }
    .ok { background: #eef7ee; color: #115511; border: 1px solid #bfe2bf; }
    .warn { background: #fff1f1; color: #8a1212; border: 1px solid #ffbcbc; }
    .small { font-size: 12px; opacity: 0.8; margin-top: 8px; }
    .pill { display:inline-block; padding:2px 8px; border-radius: 999px; border:1px solid #ddd; font-size: 12px; margin-right:6px;}
    pre { white-space: pre-wrap; margin:0; font-size:12px; background:#fafafa; border-radius:12px; padding:12px; border:1px solid #eee; max-height:220px; overflow:auto;}
  </style>
</head>

<body>
  <h2>실시간 카메라 + ml5 객체 인식</h2>

  <div class="wrap">
    <div>
      <img id="cam" alt="camera frame" />
    </div>

    <div class="panel">
      <div class="card">
        <div class="title">안내 메시지</div>
        <div id="statusMsg" class="msg ok">정상: 전방 위험 없음</div>
        <div class="small">
          <span class="pill" id="piConn">Pi: ?</span>
          <span class="pill" id="det">Detect: 준비중</span>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <div class="title">센서 수신(문자열)</div>
        <pre id="sensorBox"></pre>
      </div>
    </div>
  </div>

<script>
  // ✅ 소켓 연결 (서버/클라 버전 맞춰짐)
  const socket = io();

  const img = document.getElementById("cam");
  const statusMsg = document.getElementById("statusMsg");
  const sensorBox = document.getElementById("sensorBox");
  const piConn = document.getElementById("piConn");
  const detEl = document.getElementById("det");

  // ===== 프레임 수신 =====
  // ✅ (1번 해결) dataURL 뒤에 #t=timestamp 를 붙여서 캐시/갱신 문제 방지
  socket.on("frame", (b64) => {
    // ✅ Data URI는 그 자체로 매번 새로운 데이터이므로 캐시 방지용 태그가 필요 없음
    img.src = "data:image/jpeg;base64," + b64;
    
    // (디버깅용) 데이터가 진짜 오는지 확인하고 싶다면 아래 주석을 풀어보세요
    // console.log("Frame received, length:", b64.length);
});

  // ===== 센서 수신 =====
  socket.on("sensor", (msg) => {
    const t = new Date().toLocaleTimeString();
    sensorBox.textContent = `[${t}] ${msg}\n` + sensorBox.textContent;
  });

  // ===== health =====
  async function pollHealth() {
    try {
      const r = await fetch("/health");
      const j = await r.json();
      piConn.textContent = `Pi: ${j.pi_connected ? "연결됨" : "끊김"}`;
    } catch(e) {
      piConn.textContent = "Pi: ?";
    }
  }
  setInterval(pollHealth, 1000);
  pollHealth();

  // ===== ml5 휴대폰 감지 =====
  const PHONE_LABELS = new Set(["cell phone"]); // COCO-SSD 라벨
  const PHONE_CONF_MIN = 0.55;

  let lastPhoneSeenAt = 0;
  const HOLD_MS = 1500;

  function setMessage(isWarn, text) {
    statusMsg.className = "msg " + (isWarn ? "warn" : "ok");
    statusMsg.textContent = text;
  }

  let detector = null;

  ml5.objectDetector("cocossd", (err, d) => {
    if (err) {
      console.error(err);
      detEl.textContent = "Detect: 실패";
      return;
    }
    detector = d;
    detEl.textContent = "Detect: 실행중";
    detectLoop();
  });

  function detectLoop() {
    if (!detector) return;

    // ✅ img가 아직 프레임을 못 받은 상태면 스킵
    if (!img.src || img.naturalWidth === 0) {
      setTimeout(detectLoop, 300);
      return;
    }

    detector.detect(img, (err, results) => {
      if (!err && results) {
        let foundPhone = false;

        for (const r of results) {
          if (PHONE_LABELS.has(r.label) && r.confidence >= PHONE_CONF_MIN) {
            foundPhone = true;
            lastPhoneSeenAt = Date.now();
            setMessage(true, "⚠ 위험: 휴대폰이 감지되었습니다");
            break;
          }
        }

        if (!foundPhone && Date.now() - lastPhoneSeenAt > HOLD_MS) {
          setMessage(false, "정상: 전방 위험 없음");
        }
      }
      setTimeout(detectLoop, 500);
    });
  }
</script>

</body>
</html>
